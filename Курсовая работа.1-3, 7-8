--1. Общее текстовое описание БД и решаемых ею задач
--База данных для ПО по финансовому учёту.
Решаемые задачи:
	- Ведение учёта по нескольким счетам пользователей
  - Возможность добавлять к проводкам свойства (аналитик). Делать выборку и статистические данные по аналитике.
	- Возможность вести валютные счета, проводить обменные транзакции (проводки)
	
Основаяная сущность ПО это транзакции.
Транзакция есть у отправителя и получателя. Это прямые ссылки на таблицу счетов.
Если в транзакции счета разных валют то подразумавается что сумма(ammount) получается путем умножения на курс.
Счёт может относится как к пользователю системы, так и к организации.
Пользователи и организации имеют дополнительные атрибуты - это таблицы телефонов и реквизитов. Связь один ко многим.
--2. Создание минимум 10 таблиц.
--3. Скрипты создания структуры БД (с первичными ключами, индексами, внешними ключами).
--7. Представления (минимум 2).
--8. Хранимые процедуры / триггеры.

DROP DATABASE IF EXISTS financial_accounting;
CREATE DATABASE financial_accounting;
USE financial_accounting;

-- Пользователи----------------------------------------------
CREATE TABLE users (
	id INT AUTO_INCREMENT PRIMARY KEY,
	firstname VARCHAR(100),
	lastname VARCHAR(100),
	login VARCHAR(25) UNIQUE,
	password VARCHAR(128),  -- Для хеша паролей, 
	email VARCHAR(50) UNIQUE
);
ALTER TABLE users 
ADD COLUMN fullname VARCHAR(200) 
GENERATED ALWAYS as (CONCAT(firstname, ' ', lastname));

-- Следим что бы точно в БД попал хеш.
DELIMITER //
CREATE TRIGGER users_insert_trg BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    SET NEW.password = MD5(NEW.password);
END//
DELIMITER ;

CREATE TABLE profilies (
	user_id INT NOT NULL PRIMARY KEY,
	birthdate DATE NOT NULL,
	pasport_numer VARCHAR(50)
);

ALTER TABLE profilies
ADD CONSTRAINT fk_profile_user_id
FOREIGN KEY (user_id)
REFERENCES users(id)
ON DELETE CASCADE
ON UPDATE CASCADE;

DELIMITER //
CREATE PROCEDURE check_user_pass(IN login_ VARCHAR(25), IN password_ VARCHAR(128))
BEGIN
	DECLARE has_user BOOLEAN;
	SET has_user = EXISTS(SELECT * FROM users WHERE login = login_ and password = MD5(password_));
    IF (has_user = FALSE) THEN 
        SIGNAL SQLSTATE '45001' SET MESSAGE_TEXT = "Wrong login/password";
    END IF;
END//
DELIMITER ;
/*------------------------------------------------------------------------*/

/*--------Организации-----------------------------------------------------------*/
CREATE TABLE organization(
	id INT AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR (100) NOT NULL,
	parent_id INT DEFAULT NULL
);

ALTER TABLE organization
ADD CONSTRAINT fk_organization_parent_id
FOREIGN KEY (parent_id)
REFERENCES organization(id)
ON DELETE SET NULL
ON UPDATE CASCADE;
/*------------------------------------------------------------------------*/

/*--------Таблица типов владельцев-----------------------------------------------------------*/
CREATE TABLE owner_type (
	id INT AUTO_INCREMENT PRIMARY KEY,
	typename VARCHAR(200)
);
/*------------------------------------------------------------------------*/

/*-----------------Телефоны пользователей --------------------*/
CREATE TABLE phones (
	phone VARCHAR(25) PRIMARY KEY,
	owner_id INT NOT NULL,
	owner_type_id INT NOT NULL
);
	
ALTER TABLE phones
ADD CONSTRAINT fk_phones_owner_type_id
FOREIGN KEY (owner_type_id)
REFERENCES owner_type (id)
ON DELETE CASCADE
ON UPDATE CASCADE;
/*------------------------------------------------------------------------*/
/*-----------------Реквизиты пользователей и компаний--------------------*/


CREATE TABLE requisites (
	owner_id INT NOT NULL,
	owner_type_id INT NOT NULL,
	inn VARCHAR(12) NOT NULL,
	kpp VARCHAR(12),
	PRIMARY KEY (owner_id,owner_type_id), 
	CONSTRAINT inn_kpp UNIQUE (inn,kpp)
);

ALTER TABLE requisites
ADD CONSTRAINT fk_requisites_owner_type_id
FOREIGN KEY (owner_type_id)
REFERENCES owner_type (id)
ON DELETE CASCADE
ON UPDATE CASCADE;
/*------------------------------------------------------------------------*/

/*-----------------Валюты----------------------------------------*/

CREATE TABLE currency (
	id INT AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(50) NOT NULL UNIQUE,
	signs VARCHAR(5) NOT NULL UNIQUE,
	CODE VARCHAR(5) NOT NULL UNIQUE
);

/*-----------------Курс в определенную дату----------------------------------------*/
CREATE TABLE currency_date ( 
	currency1_id INT NOT NULL,
	currency2_id INT NOT NULL,
	curdate DATE,
	rate NUMERIC(20,4),
	PRIMARY KEY (currency1_id,currency2_id, curdate) 
);

ALTER TABLE currency_date
ADD CONSTRAINT fk_currency_date_currency1_id
FOREIGN KEY (currency1_id)
REFERENCES currency (id)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE currency_date
ADD CONSTRAINT fk_currency_date_currency2_id
FOREIGN KEY (currency2_id)
REFERENCES currency (id)
ON DELETE CASCADE
ON UPDATE CASCADE;


DELIMITER //
CREATE FUNCTION GetRate(currency1_ INT, currency2_ INT, curdate_ DATE)
RETURNS NUMERIC(20, 4) READS SQL DATA
BEGIN
    DECLARE res NUMERIC(20,4);
    IF (currency1_ = currency2_) THEN
        RETURN 1;
    END IF;
    SET res = 
  	    (SELECT rate 
  	     FROM currancy_date 
  	     WHERE currency1 = currency1_
  	       and currency2 = currency2_
  	       and curdate = curdate_
  	     );
    RETURN res;
END//
DELIMITER ;



/*------------------------------------------------------------------------*/



/*--------------------------------Счета------------------------------------*/
CREATE TABLE accounts (
	id INT AUTO_INCREMENT PRIMARY KEY,
	account NUMERIC NOT NULL UNIQUE,
	currency_id INT NOT NULL,
	owner_id INT NOT NULL,
	owner_type_id INT NOT NULL,
	name VARCHAR(100) NOT NULL UNIQUE
);

ALTER TABLE accounts
ADD CONSTRAINT fk_accounts_currency_id
FOREIGN KEY (currency_id)
REFERENCES currency(id)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE accounts
ADD CONSTRAINT fk_accounts_owner_type_id
FOREIGN KEY (owner_type_id)
REFERENCES owner_type (id)
ON DELETE CASCADE
ON UPDATE CASCADE;
/*------------------------------------------------------------------------*/


/*------------------------Транзакции-------------------------------------*/
CREATE TABLE transactions (
	id INT AUTO_INCREMENT PRIMARY KEY,
	ammount NUMERIC(20,4) NOT NULL,
	opdate DATETIME NOT NULL,
	created_at DATETIME DEFAULT NOW(),
	updated_at DATETIME DEFAULT NOW() ON UPDATE NOW(),
	payment_from INT NOT NULL,
	payment_to INT NOT NULL,
	UNIQUE(opdate, payment_from, payment_to)
); 

ALTER TABLE transactions
ADD CONSTRAINT fk_transactions_payment_from
FOREIGN KEY (payment_from)
REFERENCES accounts(id)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE transactions
ADD CONSTRAINT fk_transactions_payment_to
FOREIGN KEY (payment_to)
REFERENCES accounts(id)
ON DELETE CASCADE
ON UPDATE CASCADE;

CREATE INDEX transactions_opdate_idx ON transactions(opdate); -- для выборки за дату или период.
CREATE INDEX transactions_payment_from_idx ON transactions(payment_from); -- Индекс требуется для выписки по счётам
/*---------------------------------------------------------------------------*/

/*--------------------Аналитики, типы аналитик------------------------------------------*/
CREATE TABLE analytic_types (
	id INT AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(50)
);

CREATE TABLE analytics (
	id INT AUTO_INCREMENT PRIMARY KEY,
	name VARCHAR(50),
	type_id int NOT NULL
);

ALTER TABLE analytics
ADD CONSTRAINT fk_analytics_type_id
FOREIGN KEY (type_id)
REFERENCES analytic_types(id)
ON DELETE CASCADE
ON UPDATE CASCADE;

/*--------------------Значения аналитик------------------------------------------*/
CREATE TABLE transactions_analytics (
	transaction_id INT NOT NULL,
	analytic_id INT NOT NULL,
	analytic_value BLOB,
	PRIMARY KEY(transaction_id, analytic_id)
);

ALTER TABLE transactions_analytics
ADD CONSTRAINT fk_transactions_analytics_transaction_id
FOREIGN KEY (transaction_id)
REFERENCES transactions(id)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE transactions_analytics
ADD CONSTRAINT fk_transactions_analytics_analytic_id
FOREIGN KEY (analytic_id)
REFERENCES analytics(id)
ON DELETE CASCADE
ON UPDATE CASCADE;
/*------------------------------------------------------------------------*/

/*------ Представления из таблиц------------------------*/
/*-----Изменение курса рубля к валюте по месяцам-------*/
CREATE VIEW rate_rur_to_tgr (curmonth, avg_rate) AS
SELECT CONCAT(CONVERT(MONTH(curdate), CHAR),'-',CONVERT(YEAR(curdate), CHAR)),
    AVG(rate)
FROM currency_date
WHERE currency1_id = 1
  AND currency2_id = 10
GROUP BY curdate
ORDER BY curdate;

/*-------Среднее значение аналитики Пользователя по всем транзакциям, с группировкой по валютам--------------*/
CREATE VIEW transactions_by_user_analytics (curcode, allsum, avg_analytic_value) AS 
SELECT C.code, sum(T.ammount)
     , AVG(CAST(CONV(HEX(TA.analytic_value),16, 10) as UNSIGNED  INTEGER)/100000000) 
FROM transactions T 
	INNER JOIN transactions_analytics TA ON TA.transaction_id = T.ID
	INNER JOIN analytics A ON A.id = TA.analytic_id AND A.name = 'Метрика Карапузикова'
	INNER JOIN accounts AC ON AC.id = T.payment_from
	INNER JOIN currency C ON C.id = AC.currency_id
GROUP BY C.id
ORDER BY C.id;


/*-----------Хранимые процедуры--------------------------------*/
DELIMITER //
CREATE PROCEDURE pretty_transaction_by_period(IN begindate DATE, IN enddate DATE)
BEGIN
	SELECT   AFrom.name from_account , ATo.name to_account
           , T.ammount*GetRate(AFrom.currency_id, ATo.currency_id, T.opdate) ammount
           , C.signs  currency_to
    FROM transactions T 
        LEFT JOIN accounts AFrom 
            ON AFrom.id = T.payment_from
        LEFT JOIN accounts ATo 
            ON ATo.id = T.payment_to
        LEFT JOIN currency C
            ON C.id = ATo.currency_id
    WHERE T.opdate BETWEEN begindate AND enddate;
END//
DELIMITER ;

  

